#cloud-config

package_update: true

packages:
  - docker.io
  - xxd
  - iptables-persistent

runcmd:
  # Open firewall ports for MTProxy (OCI Ubuntu has restrictive iptables by default)
  - iptables -I INPUT 5 -p tcp --dport ${mtproxy_port} -m state --state NEW -j ACCEPT
  - iptables -I INPUT 6 -p tcp --dport ${mtproxy_port_secondary} -m state --state NEW -j ACCEPT
  - netfilter-persistent save
  - systemctl enable docker
  - systemctl start docker
  # Generate fake-TLS secret and start MTProxy with config file mode
  # Config file enables anti-replay protection against DPI probing
  - |
    BASE_SECRET="${mtproxy_secret}"
    DOMAIN="${fake_tls_domain}"
    DOMAIN_HEX=$(echo -n "$DOMAIN" | xxd -p | tr -d '\n')
    FAKE_TLS_SECRET="ee$${BASE_SECRET}$${DOMAIN_HEX}"

    echo "Starting MTProxy with fake-TLS and anti-replay"
    echo "Domain: $DOMAIN"
    echo "Secret: $FAKE_TLS_SECRET"

    # Create mtg config file with anti-replay protection and optimized settings
    cat > /home/ubuntu/mtg-config.toml << EOF
    debug = true
    secret = "$FAKE_TLS_SECRET"
    bind-to = "0.0.0.0:3128"
    domain-fronting-port = 443
    tolerate-time-skewness = "5s"
    allow-fallback-on-unknown-dc = true

    [defense.anti-replay]
    enabled = true
    max-size = "1mib"
    error-rate = 0.001

    [defense.blocklist]
    enabled = true
    download-concurrency = 2
    urls = [
        "https://iplists.firehol.org/files/firehol_level1.netset"
    ]
    update-each = "24h"

    [network.timeout]
    tcp = "30s"
    http = "30s"
    idle = "5m"
    EOF

    # nineseconds/mtg v2 with config file
    docker run -d --name mtproxy --restart always \
      -p ${mtproxy_port}:3128 \
      -v /home/ubuntu/mtg-config.toml:/config.toml:ro \
      nineseconds/mtg:2 run /config.toml

  # Secondary proxy using prebuilt OCIR image with environment variables
  - |
    echo "Logging into OCIR..."
    echo "${ocir_token}" | docker login fra.ocir.io -u "${ocir_username}" --password-stdin

    echo "Starting Secondary MTProxy from OCIR image"
    echo "Domain: ${fake_tls_domain_secondary}"
    echo "Port: ${mtproxy_port_secondary}"

    # Secondary proxy using custom OCIR image (config via env vars)
    docker run -d --name mtproxy-secondary --restart always \
      -p ${mtproxy_port_secondary}:${mtproxy_port_secondary} \
      -e MTG_SECRET="${mtproxy_secret_secondary}" \
      -e MTG_DOMAIN="${fake_tls_domain_secondary}" \
      -e MTG_PORT="${mtproxy_port_secondary}" \
      fra.ocir.io/fratzuns8xud/mtproxy:latest
