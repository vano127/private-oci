#cloud-config
package_update: true
package_upgrade: true

packages:
  - curl
  - jq

runcmd:
  # Install Docker on Oracle Linux 8
  - dnf config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo
  - dnf install -y docker-ce docker-ce-cli containerd.io
  - systemctl enable docker
  - systemctl start docker

  # Write MTProxy secret (generated by Terraform)
  - mkdir -p /opt/mtproxy
  - echo "${mtproxy_secret}" > /opt/mtproxy/secret.txt

  # Get Telegram proxy secret (for connecting to Telegram servers)
  - curl -s https://core.telegram.org/getProxySecret -o /opt/mtproxy/proxy-secret

  # Get Telegram proxy config
  - curl -s https://core.telegram.org/getProxyConfig -o /opt/mtproxy/proxy-multi.conf

  # Create systemd service for MTProxy
  - |
    cat > /etc/systemd/system/mtproxy.service << 'EOF'
    [Unit]
    Description=MTProxy Telegram Proxy
    After=docker.service
    Requires=docker.service

    [Service]
    Type=simple
    WorkingDirectory=/opt/mtproxy
    ExecStartPre=/usr/bin/docker pull telegrammessenger/proxy:latest
    ExecStart=/bin/bash -c '/usr/bin/docker run --rm --name mtproxy -p ${mtproxy_port}:443 -v /opt/mtproxy/proxy-secret:/data/proxy-secret:ro -v /opt/mtproxy/proxy-multi.conf:/data/proxy-multi.conf:ro -e SECRET_COUNT=1 -e SECRET=$$(cat /opt/mtproxy/secret.txt) telegrammessenger/proxy:latest'
    ExecStop=/usr/bin/docker stop mtproxy
    Restart=always
    RestartSec=10

    [Install]
    WantedBy=multi-user.target
    EOF

  # Reload systemd daemon
  - systemctl daemon-reload

  # Enable and start MTProxy service
  - systemctl enable mtproxy
  - systemctl start mtproxy

  # Create script to display connection info
  - |
    cat > /opt/mtproxy/show-connection.sh << 'SCRIPT'
    #!/bin/bash
    PUBLIC_IP=$(curl -s ifconfig.me)
    SECRET=$(cat /opt/mtproxy/secret.txt)
    PORT=${mtproxy_port}
    echo "========================================"
    echo "MTProxy Connection Information"
    echo "========================================"
    echo "Server: $PUBLIC_IP"
    echo "Port: $PORT"
    echo "Secret: $SECRET"
    echo ""
    echo "Telegram Link:"
    echo "https://t.me/proxy?server=$PUBLIC_IP&port=$PORT&secret=$SECRET"
    echo "========================================"
    SCRIPT
  - chmod +x /opt/mtproxy/show-connection.sh

  # Configure firewall
  - firewall-cmd --permanent --add-port=${mtproxy_port}/tcp
  - firewall-cmd --permanent --add-port=22/tcp
  - firewall-cmd --reload

write_files:
  - path: /opt/mtproxy/update-config.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      curl -s https://core.telegram.org/getProxySecret -o /opt/mtproxy/proxy-secret
      curl -s https://core.telegram.org/getProxyConfig -o /opt/mtproxy/proxy-multi.conf
      systemctl restart mtproxy

  - path: /etc/cron.daily/mtproxy-update
    permissions: '0755'
    content: |
      #!/bin/bash
      /opt/mtproxy/update-config.sh
